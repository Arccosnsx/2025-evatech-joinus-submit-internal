user www-data;
worker_processes auto;

events {
         worker_connections 768;
       # multi_accept on;
        }

stream {
        map $ssl_preread_server_name $backend {
        mc.nishx.com          192.168.1.120:33289;
        pve.nishx.com         127.0.0.1:443;
        cms.nishx.com         127.0.0.1:443;
        cms4.nishx.com        127.0.0.1:443;
        cms4-hk.nishx.com     127.0.0.1:443;
        pve4.nishx.com        192.168.1.2:8006;
        default               127.0.0.1:9;    
        }

        server {
                listen 52000;
                proxy_pass $backend;
                ssl_preread on;
        }

        server {
                listen 63333;
                proxy_pass 192.168.1.120:44440;
        }
}
http {
        sendfile on;
        tcp_nopush on;
        types_hash_max_size 2048;

        include /usr/local/nginx/conf/mime.types;
        default_type application/octet-stream;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3; # Dropping SSLv3, ref: POODLE
        ssl_prefer_server_ciphers on;
        Logging Settings
        access_log /usr/local/nginx/logs/access.log;

        gzip on;

        include /usr/local/nginx/conf/conf.d/*.conf;
}

server {
        listen 443 ssl;
        listen [::]:443 ssl;
        server_name domain.nishx.com;
        ssl_certificate /etc/letsencrypt/live/nishx.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/nishx.com/privkey.pem;

        location / {
                return 403;
        }
}

server {
        listen 443 ssl;
        listen [::]:443 ssl;
        server_name pve.nishx.com;
        ssl_certificate /etc/letsencrypt/live/nishx.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/nishx.com/privkey.pem;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
        ssl_prefer_server_ciphers on;
        ssl_session_timeout 1d;
        ssl_session_cache shared:SSL:10m;

        add_header Strict-Transport-Security "max-age=63072000; includeSubdomains; preload";
        add_header X-Frame-Options SAMEORIGIN;
        add_header X-Content-Type-Options nosniff;

        location / {
                proxy_pass https://[fd00:43::2]:8006/;

                proxy_buffering off;
                proxy_buffer_size 4k;
                proxy_connect_timeout 300s;
                proxy_read_timeout 86400s;
                proxy_send_timeout 300s;
                send_timeout 300s;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";

                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-Host $server_name;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_set_header X-Forwarded-Ssl on;
                proxy_set_header X-NginX-Proxy true;
        }
}


server {
        listen 443 ssl;
        listen [::]:443 ssl;
        server_name cms.nishx.com;
        ssl_certificate /etc/letsencrypt/live/nishx.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/nishx.com/privkey.pem;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
        ssl_prefer_server_ciphers on;
        ssl_session_timeout 1d;
        ssl_session_cache shared:SSL:10m;
        add_header Strict-Transport-Security "max-age=63072000; includeSubdomains; preload";
        add_header X-Frame-Options SAMEORIGIN;
        add_header X-Content-Type-Options nosniff;

        client_max_body_size 0;

        location / {
                proxy_pass https://[fd00:43::211]:5001/;
                proxy_buffering off;
                proxy_buffer_size 4k;
                proxy_connect_timeout 300s;
                proxy_read_timeout 86400s;
                proxy_send_timeout 300s;
                send_timeout 300s;

                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";

                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-Host $server_name;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_set_header X-Forwarded-Ssl on;
                proxy_set_header X-NginX-Proxy true;
        }
}

server {
        listen 443 ssl;
        listen [::]:443 ssl;
        server_name cms4.nishx.com cms4-hk.nishx.com;
        ssl_certificate /etc/letsencrypt/live/nishx.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/nishx.com/privkey.pem;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
        ssl_prefer_server_ciphers on;
        ssl_session_timeout 1d;
        ssl_session_cache shared:SSL:10m;
        add_header Strict-Transport-Security "max-age=63072000; includeSubdomains; preload";
        add_header X-Frame-Options SAMEORIGIN;
        add_header X-Content-Type-Options nosniff;

        client_max_body_size 0;

        location / {
                proxy_pass https://[fd00:43::211]:5001/;
                proxy_buffering off;
                proxy_buffer_size 4k;
                proxy_connect_timeout 300s;
                proxy_read_timeout 86400s;
                proxy_send_timeout 300s;
                send_timeout 300s;

                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";

                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-Host $server_name;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_set_header X-Forwarded-Ssl on;
                proxy_set_header X-NginX-Proxy true;
        }
}